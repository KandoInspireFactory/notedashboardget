# note分析 Basic v7 仕様書 (2025/12/28)

## 1. 概要
noteの公式統計APIからデータを取得し、自身の記事のパフォーマンスを可視化するStreamlitアプリケーション。
「知識がある人向けのローカル実行」および「知識がない人向けのRenderデプロイ」の両方に対応する。

## 2. システム構成
- **言語**: Python 3.10+
- **フレームワーク**: Streamlit
- **データベース**: 
    - ローカル：SQLite (`note_dashboard.db`)
    - クラウド：Neon (PostgreSQL)
- **主なライブラリ**: pandas, plotly, requests, psycopg2-binary, python-dotenv

## 3. 主要機能
### 3.1 認証・取得
- メールアドレスとパスワードによるログイン（note APIセッション認証）。
- 統計API（累計PV/スキ/コメント）の全件取得。
- 重複排除ロジック（acquired_at と article_id による PRIMARY KEY 制約）。

### 3.2 データ表示（ダッシュボード）
- **サマリー**: 公開記事数、累計総ビュー数、累計総スキ数（前回取得時からの増分を表示）。
- **全体累計ビュー推移**: 全記事の合計ビュー数の時系列推移グラフ（折れ線）。
- **ランキング（タブ切り替え）**:
    - 累計ランキング：全期間のビュー数TOP20。
    - 本日の伸び：前回取得時から増分が大きかった記事TOP20。
- **個別推移**: 全記事の個別ビュー数推移グラフ（凡例非表示・ホバー詳細付き）。

### 3.3 UX/UI設計
- **初回ユーザー対応**: データが1日分しかない場合、推移グラフや増分表示の代わりに「明日また取得してください」というガイダンスを表示。
- **データポータビリティ**: 蓄積されたSQLiteデータベース（.dbファイル）の直接ダウンロード機能（ローカルモード時のみ）。

## 4. データ構造 (article_statsテーブル)
| カラム名 | 型 | 説明 |
| :--- | :--- | :--- |
| user_id | TEXT | ユーザー識別子（PRIMARY KEY 1） |
| acquired_at | TEXT | 取得日時（PRIMARY KEY 2） |
| article_id | BIGINT | note記事固有ID（PRIMARY KEY 3） |
| title | TEXT | 記事タイトル |
| views | INTEGER | 累計ビュー数 |
| likes | INTEGER | 累計スキ数 |
| comments | INTEGER | 累計コメント数 |

## 5. 実行モードの自動切替 (Hybrid Logic)
環境変数の設定状況により、アプリケーションは自動的に挙動を切り替える。

### 5.1 ローカル配布モード (Local Mode)
- **判定条件**: 環境変数 `DATABASE_URL` が未設定の場合。
- **データベース**: ローカルの `note_dashboard.db` (SQLite) を使用。
- **認証**: アプリログインはスキップ。サイドバーのnote認証のみで動作。
- **用途**: 知識があるユーザーが自身のPCで個人利用する場合。

### 5.2 クラウド運用モード (Cloud Mode)
- **判定条件**: 環境変数 `DATABASE_URL` および `NEON_API_KEY` が設定済みの場合（Render等）。
- **データベース**: Neon (PostgreSQL) を使用。
- **認証**: 
    1. **アプリログイン**: アプリ利用開始前にメールアドレスとパスワードによる認証が必須。
    2. **新規登録**: ユーザー自身によるアカウント作成が可能（Neon RPC経由）。
- **用途**: 知識がない一般ユーザー向けにSaaS形式で提供する場合。

## 6. 管理者権限 (Admin Features)
環境変数 `ADMIN_EMAIL` に設定されたメールアドレスでログインしたユーザーのみ、以下の特権を利用できる。
- **現在の管理者設定**: `s3792.01@gmail.com`

### 6.1 認証プロセス
1. アプリログイン画面で「メールアドレス」と「パスワード」を入力して認証を通過する。
2. システムが `ADMIN_EMAIL` との一致を確認し、管理者メニューを開放する。

### 6.2 管理機能
- **ユーザー一覧**: 登録されている全ユーザーのメールアドレスと登録日を閲覧可能。
- **パスワードリセット**: パスワードを忘れたユーザーに対し、新しいパスワードを強制的に再設定可能。
