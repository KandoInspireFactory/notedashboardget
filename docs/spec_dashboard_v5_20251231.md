# note分析 Basic v5 仕様書 (2025/12/31 Update)

**ベースバージョン**: v7_basic (v4 app)
**改修バージョン**: v5.1 (App Version)

## 1. 改修の目的・方針
### 1.1 「クラウドマスター」運用
データの一貫性を保つため、**「クラウド（Render/Neon）にあるデータが正（マスター）」**という運用ルールをシステム側で支援する設計とする。
ローカル環境はあくまで「開発・実験用」と位置づけ、クラウドからデータを同期（ダウンロード）して使用するフローを確立する。

### 1.2 過去データの統合
ユーザーが過去に収集したCSVやExcelデータを、クラウド上のDBに一括インポート可能にし、長期的なデータ推移の分析を可能にする。

## 2. 変更点・新機能

### 2.1 データフォルダ構成の整理
プロジェクトルート直下へのファイル散乱を防ぐため、データ関連ファイルを `note_data/` フォルダへ集約する。
*   旧バージョンからの自動移行（ファイル移動）ロジックを実装済み。

### 2.2 データインポート機能
*   **対応フォーマット**: CSV (V3ツール互換), Excel (`.xlsx`, `.xlsm`).
*   **インポート仕様**: 列の自動認識、記事ID自動補完、重複ガード。
*   **サンプル提供**: アプリ内からCSVサンプルをダウンロード可能。

### 2.3 データ同期・ダウンロード機能
*   **クラウド実行時**: PostgreSQLデータをSQLite形式(`.db`)に変換してダウンロード可能。
*   **ローカル実行時**: DBファイルをそのままダウンロード。

### 2.4 管理者機能の強化 (2025/12/31 New)
*   **永久許可設定**: 
    *   管理者画面（`🛠️ ユーザー管理`）において、ユーザーごとに「永久許可（Stripe決済免除）」の付与・解除をボタン一つで切り替え可能に変更。
    *   `skip_stripe` フラグをデータベース上で直接操作する。

### 2.5 UI/UXの改善 (Update)
*   **ダッシュボード**:
    *   「累計ランキング」「本日の伸び」「生データ」タブの直前に、見出し **「📊 記事別累計ビューランキング (TOP 20)」** を追加し、視認性を向上。
*   **グラフ**:
    *   ホバー時のタイトル全文表示、凡例非表示、強調表示の最適化。

## 3. データベース設計 (変更なし)
*   **テーブル**: `article_stats`, `app_users`
*   **カラム**: 
    *   `article_stats`: `user_id`, `acquired_at`, `article_id`, `title`, `views`, `likes`, `comments`
    *   `app_users`: `id`, `email`, `password_hash`, `is_approved`, `skip_stripe`, `created_at`

## 4. 運用フロー
1.  **日々の更新**: Render上のアプリで「最新データを取得」ボタンを押す。
2.  **管理**: 管理者はユーザーの決済状況や特別対応（永久許可）を管理画面で行う。
3.  **分析**: RenderからDBファイルをダウンロードし、手元のPCで分析や開発を行う。

## 5. リリース情報
*   **Version**: v5.1
*   **Code Commit Hash**: `5cab56f`
*   **Status**: **Deployed to Render** (Start Command: `streamlit run noteAPIv8_steamlitV5.py`)
*   **Date**: 2025-12-31