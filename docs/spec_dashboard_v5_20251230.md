# note分析 Basic v5 仕様書 (2025/12/30)

**ベースバージョン**: v7_basic (v4 app)
**改修バージョン**: v5 (App Version)

## 1. 改修の目的・方針
### 1.1 「クラウドマスター」運用
データの一貫性を保つため、**「クラウド（Render/Neon）にあるデータが正（マスター）」**という運用ルールをシステム側で支援する設計とする。
ローカル環境はあくまで「開発・実験用」と位置づけ、クラウドからデータを同期（ダウンロード）して使用するフローを確立する。

### 1.2 過去データの統合
ユーザーが過去に収集したCSVやExcelデータを、クラウド上のDBに一括インポート可能にし、長期的なデータ推移の分析を可能にする。

## 2. 変更点・新機能

### 2.1 データフォルダ構成の整理
プロジェクトルート直下へのファイル散乱を防ぐため、データ関連ファイルを `note_data/` フォルダへ集約する。
*   旧バージョンからの自動移行（ファイル移動）ロジックを実装済み。

### 2.2 データインポート機能 (New)
*   **対応フォーマット**:
    *   **CSV**: V3ツール互換形式。Shift-JIS/UTF-8を自動判別。
    *   **Excel**: `.xlsx` および `.xlsm` (マクロ有効ブック) に対応。
*   **インポート仕様**:
    *   **列の自動認識**: 「日付/Date」「タイトル/Title」「ビュー/PV」などの表記揺れを吸収。
    *   **記事ID自動補完**: ユーザーは記事IDを入力不要。最新のDBから「タイトル」をキーにIDを逆引きして紐付ける。
        *   IDが見つからない（削除済み記事など）場合は、タイトルからハッシュ値を生成し、負の仮IDとして保存する。
    *   **重複ガード**: (user_id, acquired_at, article_id) の複合キーで重複チェックを行い、既存データがある場合はスキップ。
*   **サンプル提供**: アプリ内から「インポート用サンプルファイル（CSV形式）」をダウンロード可能。

### 2.3 データ同期・ダウンロード機能の強化
*   **クラウド実行時 (Render/Neon接続時)**:
    *   PostgreSQL上のデータを全件取得し、SQLite形式(`.db`)に変換してダウンロードさせる機能を実装。
    *   **ファイル名**: `note_dashboard_cloud_YYYYMMDD.db`
*   **ローカル実行時**:
    *   `note_data/note_dashboard.db` をそのままダウンロード。

### 2.4 データ取得状況の可視化
*   **ヒートマップカレンダー**:
    *   「📥 データ管理」タブの上部に、直近6ヶ月のデータ取得状況を表示。
    *   **緑色**: データあり / **白色**: データなし（取り込み漏れ）。
    *   目的: 取得漏れを一目で把握し、直下のインポート機能での補完を促す。

## 3. データベース設計 (変更なし)
*   **テーブル**: `article_stats`
*   **カラム**: `user_id`, `acquired_at`, `article_id`, `title`, `views`, `likes`, `comments`
*   **PK**: `(user_id, acquired_at, article_id)`

## 4. 運用フロー
1.  **日々の更新**: Render上のアプリで「最新データを取得」ボタンを押す。
2.  **過去データの補完**: 手元のExcel/CSVを「データ管理」画面からアップロード。
3.  **ローカル分析**: RenderからDBファイルをダウンロードし、手元のPCで分析や開発を行う。