# 開発ログ: noteAPI v7 配布版・クラウド版完成 (2025/12/28)

## 本日の実施内容
### 1. データベースの統合と安定化
- 読み書きするデータベースを `note_dashboard.db` に一本化。
- `pd.to_datetime(format='mixed')` を導入し、多様な日付形式の混在エラーを解消。

### 2. グラフ表示のネイティブ化（Streamlit/Plotly）
- 外部HTMLファイルを廃止し、プログラム内で `st.plotly_chart` を生成する方式へ変更。
- サイドバー更新後の即時反映と、デザインの統一を実現。

### 3. デイリー増分計算の実装
- 最新と前回のデータを `article_id` でマージし、差分（views_delta）を算出。
- サマリー指標への `delta` 表示および「本日の伸び」ランキングタブを新設。

### 4. インフラ拡張（SQLite/Neon ハイブリッド化）
- **Git連携**: リポジトリ `notedashboardget.git` への接続とプッシュを完了。
- **ハイブリッド化**: `DATABASE_URL` の有無で SQLite と Neon (Postgres) を自動切替。
- **Renderデプロイ**: クラウド上での永続データ蓄積環境を構築。

### 5. クラウド運用基盤の完成（マルチユーザー・管理者対応）
- **Neon Auth連携**: アプリ独自のログイン・新規登録画面を実装。
- **ユーザー識別**: `user_id` カラムを導入し、同一テーブル内でのユーザーデータ分離を実現。
- **管理者ダッシュボード**: `ADMIN_EMAIL` による権限管理。ユーザー一覧閲覧とパスワードリセット機能を搭載。
- **管理者設定完了**: `s3792.01@gmail.com` を管理者として `.env` および Render に設定。

## コミット履歴
- `5a63c5b`: PostgreSQL移行完了
- `75f6a15`: 配布・Render両対応ハイブリッド版
- `bfec046`: Neon Auth認証・マルチユーザー対応
- `ffa85d4`: 新規登録機能（Sign-Up）追加
- `7186f08`: 管理者画面・パスワードリセット実装
- `d8e19b4`: SQLセットアップスクリプト整備

## 7. トラブルシューティング：認証エラー（400 JWT encoding）の解決
- **事象**: Neon Data API (HTTP) を介した新規登録・ログイン時に「Provided authentication token is not a valid JWT encoding」エラーが発生。
- **分析**: API Key を `Authorization: Bearer` ヘッダーで送った際、サーバー側が JWT 形式を強制するためミスマッチが発生。
- **解決策**: HTTP API 経由ではなく、既に記事データの保存で実績のあった **「直接DB接続 (psycopg2)」** を認証ロジックにも採用。
- **結果**: ネットワーク層の制限を受けなくなり、ローカルおよびクラウド両環境での 100% 安定した認証動作を確立。
- **コミット記録**: `8aaa168` (直接DB接続方式による認証安定化版)

## 今後の課題
- 利用制限（クォータ）の導入。
- AIアドバイス機能（Gemini API連携）のマルチユーザー対応。
